
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>JS-Free Live Chat — Accursed Ware</title>
  <meta name="author" content="John Krauss"/>

  
  <meta name="description" content="Foo bar baz."/>
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  
  <link rel="canonical" href="http://blog.johnkrauss.com/html-only-live-chat-No-JS"/>
  <link href="/favicon.png" rel="icon"/>
  <link href="/stylesheets/bootstrap.min.css" rel="stylesheet" type="text/css"/>
  <link href="/stylesheets/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"/>
  <link href="/atom.xml" rel="alternate" title="Accursed Ware" type="application/atom+xml"/>
  <script src="//cdn.jsdelivr.net/jquery/1.11/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.min.js"><\/script>')</script>
  
  <script type="text/javascript" src="//use.typekit.net/ijs2xpi.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  
  
  

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20153319-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  
  <header role="banner">
  <h1><a href="/">Accursed Ware</a></h1>


  <h2>blog of john krauss, hacker, mapper, etc. <a href="https://github.com/talos" target="_blank">github.com/talos</a> <a href="https://twitter.com/recessionporn" target="_blank">@recessionporn</a></h2>


</header>
  
  <nav class="navbar navbar-static-top" role="navigation"><div class="nav-collapse collapse">
<!--
<ul class="nav subscription pull-right" data-subscription="rss">
  <li><a href="/atom.xml" rel="alternate" data-type="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
-->
  
</div>
<!--
<ul class="nav main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>
-->

</nav>
  <div id="content" class="container">
    <article class="hentry span8 offset2" role="article">
  
  <header>
    
      
      
      <h1 class="entry-title">JS-Free Live Chat</h1>
    
    
      <p class="meta">
        










<time datetime="2012-02-28T00:00:00-08:00" data-updated="true">Feb 28<span>th</span>, 2012</time>
      </p>
    
  </header>


<div class="entry-content lettrine"><p>I built a <a href="http://www.nodotjs.com/">real-time web-based chat</a> without a line of client-side code.  No
JavaScript, no Flash, no (ew) Java applet.  100% HTML.  It even works in
<a href="http://en.wikipedia.org/wiki/Internet_Explorer_4">Internet Explorer 4</a>, emulated with <a href="http://sheepshaver.cebix.net/">SheepShaver</a>.</p>

<p><a href="https://github.com/talos/no.js/raw/master/assets/img/ie4.png" target="_blank">
  <img src="https://github.com/talos/no.js/raw/master/assets/img/ie4-thumb.png" width="640" height="311" />
</a></p>

<p>Because I remember the canonical <a href="http://www.nodejs.org/">node.js</a> example being a chat server, I
had to call it <a href="http://www.nodotjs.com/">No.JS</a> (no-dot-JS, got it? Haha. Sorry.)</p>

<p><img src="https://github.com/talos/no.js/raw/master/assets/img/logo.gif" alt="No (dot) JS" /></p>

<p>To be fair, the backend could have been built in JavaScript using Node, instead
of Python using <a href="http://www.brubeck.io/">Brubeck</a>.  It would make for the dandy perversity of having
exclusively server-side JavaScript.</p>

<p>All the code for it is <a href="http://www.github.com/talos/no.js">on GitHub</a>, so all you Node-hackers should go ahead
and build a JavaScript edition…</p>

<hr />

<p>Why’d I do this, and how does it work?</p>

<p>I’m building a real-time browser-based multiplayer game, using the same
templates (<a href="http://mustache.github.com/">Mustache</a>) on the client and server-side.  Instead of messing
around with WebSockets, I used AJAX long polling to push updates from the
server to the client.  Since the server could render all the views, I set up a
little <code class="language-plaintext highlighter-rouge">Accept</code> header goodness so that browsers with JavaScript turned off
could still play… but the problem of pushing the state remained.</p>

<p>There is the peculiarly irritating <code class="language-plaintext highlighter-rouge">&lt;meta http-equiv="refresh" ...&gt;</code> tag,
embedded in my consciousness from some late-90s “dynamic” interfaces.  Every
few seconds, the page would flash to refresh with possibly new content.
Maddeningly, you would be thrown back to the top of an identical (or very
slightly modified) page.</p>

<p>Throwing the meta refresh inside a <code class="language-plaintext highlighter-rouge">&lt;noscript /&gt;</code> would make the game kind-of
work, while not irritating the majority of JavaScript-enabled users. 
The refresh still wouldn’t be live, though. And the more frequent it was,
the more irritating it would be.</p>

<p>So why not just long-poll the whole page?</p>

<p>Browsers wait for a response before wiping the contents of a window.  The prior
page works the same while a new page is loading.  The server can dictate
exactly when the page should reload.</p>

<p>The stakes are higher than when long polling an AJAX request.  If the server
doesn’t get back to the client with a response eventually, the browser doesn’t
merely log to the error console – it replaces the page with a message that
the server is down.  Responding with identical content at least twice a minute
prevents this.</p>

<p>To put it all together, the Mustache template would look like this in the
header:</p>

<pre>
&lt;!-- Only fuss with this for those without JavaScript. --&gt;
&lt;noscript&gt;
    &lt;!-- The content of the refresh header is generated by the handler. --&gt; 
    &lt;meta http-equiv="refresh" content=&#123;&#123;refresh&#125;&#125; /&gt;
&lt;/noscript&gt;
</pre>

<p>And this in the body:</p>

<pre>
&#123;&#123;#content&#125;&#125;
    &lt;!-- Exciting rapidly changing content! --&gt; 
&#123;&#123;/content&#125;&#125;
</pre>

<p>The function to generate content, using <a href="http://www.redis.io/">Redis</a>, would look like:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_page_content</span><span class="p">(</span><span class="n">old_id</span><span class="p">):</span>
    <span class="c1"># If an old ID was specified, and it's equal to the current ID,
</span>    <span class="c1"># subscribe to updates on the 'updates' channel of our Redis database.
</span>    <span class="c1"># Then listen for an update.  Whatever triggers the update should also
</span>    <span class="c1"># modify the ID.
</span>    <span class="k">if</span> <span class="n">old_id</span> <span class="ow">and</span> <span class="n">old_id</span> <span class="o">==</span> <span class="n">db</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">):</span>
        <span class="n">pubsub</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">pubsub</span><span class="p">()</span>
        <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="sh">'</span><span class="s">updates</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">pubsub</span><span class="p">.</span><span class="nf">listen</span><span class="p">().</span><span class="nf">next</span><span class="p">()</span> 
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1"># Populate the refresh header in the template with the new
</span>        <span class="c1"># ID.  The `0;` means that the browser will immediately
</span>        <span class="c1"># try to reload the page -- but will hang, because the
</span>        <span class="c1"># reload is for the new ID. 
</span>        <span class="sh">'</span><span class="s">refresh</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">0; url=?id=%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">db</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">),</span>
        <span class="c1"># This would be a separate function, but you get the point.
</span>        <span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">:</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">))</span> 
    <span class="p">}</span></code></pre></figure>

<p>The handler, using <a href="http://www.brubeck.io/">Brubeck</a> with <a href="http://www.gevent.org/">gevent</a>, would look like:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">PageHandler</span><span class="p">(</span><span class="n">MustacheRendering</span><span class="p">):</span>

    <span class="c1"># The route is specified elsewhere, but this method will be called
</span>    <span class="c1"># when there is a vanilla HTTP GET for the page.
</span>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Pull out the last loaded page ID.  Will be `None` if none was
</span>        <span class="c1"># specified.
</span>        <span class="n">old_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># See `get_page_content` above.
</span>            <span class="n">context</span> <span class="o">=</span> <span class="n">gevent</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">with_timeout</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">get_page_content</span><span class="p">,</span> <span class="n">old_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">gevent</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="c1"># The timeout above was for thirty seconds.  If nothing changes
</span>            <span class="c1"># after that time, the client is simply redirected back to the
</span>            <span class="c1"># original page with no ID argument at all.  This will cause
</span>            <span class="c1"># an immediate reload.
</span>            <span class="c1">#
</span>            <span class="c1"># We do this instead of redirecting to `"?id=%s" % old_id` 
</span>            <span class="c1"># because that would cause another hang, and possibly another
</span>            <span class="c1"># 3xx response if we hit this timeout again.  If nothing
</span>            <span class="c1"># changes for a few minutes, which is likely, then the repeated
</span>            <span class="c1"># redirects would wipe the page with a `too many redirects`
</span>            <span class="c1"># error.  This avoids that eventuality. :)
</span>            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="sh">'</span><span class="s">?</span><span class="sh">'</span><span class="p">)</span></code></pre></figure>

<p>Neato!</p>

<p>No.JS is pulled from the game’s chat component.  Chat is tricky, because a
refresh wipes forms.  You’re typing, someone says something… and everything
you were about to say goes to the bitbucket.  Keeping the chat messages inside
an <code class="language-plaintext highlighter-rouge">&lt;iframe /&gt;</code> solves this problem.  I switched it out for a regular frame
in No.JS to support older browsers.</p>
</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">John Krauss</span></span>

      










<time datetime="2012-02-28T00:00:00-08:00" data-updated="true">Feb 28<span>th</span>, 2012</time>
      


    </p>
    <p class="meta">
      
        
          <a class="basic-alignment left" href="/nypd-crash-data-band-aid/" title="Previous Post: NYPD crash data band-aid">&larr;<span class="hide-mobile">&nbsp;NYPD crash data band-aid</span></a>
        
        
          <a class="basic-alignment right" href="/nonagenarian-laptop/" title="Next Post: Preparing a Mac laptop for your Grandma"><span class="hide-mobile">Preparing a Mac laptop for your Grandma&nbsp;</span>&rarr;</a>
        
      
    </p>
  </footer>
	
	<section id="comments">
		<h1>Comments</h1>
		
		
		<div id="disqus_thread" aria-live="polite">
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

		</div>
		
	</section>
	
</article>

  </div>
  <footer role="contentinfo"><a rel="license" href="/license" class="CC">
  <img alt="Creative Commons License" src="/img/cc-by-nc-small.png">
</a>

<script src="/js/typo.js"></script>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'accursedware';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.johnkrauss.com/html-only-live-chat-No-JS/';
        var disqus_url = 'http://blog.johnkrauss.com/html-only-live-chat-No-JS/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>








</body>
</html>
